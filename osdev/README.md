# OCap OS Dev Exploration with VirtualBox

This directory contains tools to create a [VirtualBox VM](https://en.wikipedia.org/wiki/VirtualBox) that boots from a physical disk, for operating system development experiments.

## Prerequisites

-   **jq**: This tool is used for parsing the partition table. You can install it with `sudo apt-get install jq` on Debian/Ubuntu.

## Setup

1.  **Check Configuration**: The `Makefile` has defaults for `TARGET_DISK` and `VM_NAME`. To see them, run `make -C osdev`. To override, set environment variables:
    ```sh
    export TARGET_DISK=/dev/disk/by-id/ata-YOUR_DISK_NAME_HERE  # WARNING: Use a stable name from 'ls /dev/disk/by-id'
    ```
    **WARNING**: Subsequent steps can wipe this disk.

2.  **Set Permissions**: Grant your user access to [raw disks](https://en.wikipedia.org/wiki/Raw_device).
    ```sh
    make perms
    ```
    Then, **log out and log back in** for the group change to take effect.

3.  **Create VMDK**: Generate the [.vmdk file](https://en.wikipedia.org/wiki/VMDK) that points to the physical disk.
    ```sh
    make physical.vmdk
    ```

4.  **Create VirtualBox VM**:
    ```sh
    make create-vm
    ```
    This creates a VM definition in VirtualBox that uses the `.vmdk` file and enables [EFI](https://en.wikipedia.org/wiki/UEFI) booting.

5.  **Provision Disk (Optional & DESTRUCTIVE)**: If the disk is empty, you can [partition](https://en.wikipedia.org/wiki/Disk_partitioning) and format it. First, you can check if it's already provisioned correctly:
    ```sh
    sudo make -C osdev check-partitioning
    sudo make -C osdev check-formatting
    ```
    If not, you can use the destructive targets. The [partition layout](https://en.wikipedia.org/wiki/Disk_partitioning) is defined in `partition-table.sfdisk`. **THIS WILL WIPE THE DISK.**
    ```sh
    # Example for partitioning and formatting
    sudo make partition-disk
    sudo make format-disk
    ```

6.  **Run**:
    ```sh
    make run
    ```

### Cleanup

If `create-vm` fails or if you want to remove the VM definition from VirtualBox, run:
```sh
make destroy-vm
```

To remove the generated `.vmdk` file and force its recreation on the next run, use:
```sh
make clean
```

## Files

-   `README.md`: This file.
-   `Makefile`: Automation for setup and management.
-   `partition-table.sfdisk`: Declarative partition layout for the target disk.
-   `check-partition-layout.jq`: A `jq` script to validate the partition layout.
-   `physical.vmdk`: A placeholder file. The real file is generated by `make physical.vmdk` and points VirtualBox to a raw physical disk.

## Acknowledgements

The approach documented here is based on:

-   [How to Use a Physical Hard Drive with a VirtualBox VM](https://www.serverwatch.com/guides/how-to-use-a-physical-hard-drive-with-a-virtualbox-vm/) by Franklin Okeke, Mar 22, 2023.

## TODO

-   Consider [LVM](https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)) or [btrfs](https://en.wikipedia.org/wiki/Btrfs) to allow for multiple resizable volumes.
