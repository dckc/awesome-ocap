# OCap OS Dev Exploration with VirtualBox

This directory contains tools to create a [VirtualBox VM](https://en.wikipedia.org/wiki/VirtualBox) that boots from a physical disk, for operating system development experiments.

## Prerequisites

-   **Guix**, **VirtualBox**, **jq**, and standard Linux disk utilities must be installed.
-   On Debian/Ubuntu, `jq` can be installed with `sudo apt-get install jq`, `sgdisk` with `sudo apt-get install gdisk`, `partprobe` with `sudo apt-get install parted`, and GRUB with `sudo apt-get install grub-efi-amd64-bin`. For Guix installation, see the [official documentation](https://guix.gnu.org/manual/en/html_node/Binary-Installation.html).
-   The paths to these tools can be overridden, e.g., `make JQ=/path/to/jq ...`.

## Setup

1.  **Check Configuration**: The `Makefile` has defaults for `TARGET_DISK` and `VM_NAME`. To see them, run `make -C osdev`. To override, set environment variables:
    ```sh
    export TARGET_DISK=/dev/disk/by-id/ata-YOUR_DISK_NAME_HERE  # WARNING: Use a stable name from 'ls /dev/disk/by-id'
    ```
    **WARNING**: Subsequent steps can wipe this disk.

2.  **Set Permissions**: Grant your user access to [raw disks](https://en.wikipedia.org/wiki/Raw_device).
    ```sh
    make -C osdev perms
    ```
    Then, **log out and log back in** for the group change to take effect.

3.  **Create VMDK**: Generate the [.vmdk file](https://en.wikipedia.org/wiki/VMDK) that points to the physical disk.
    ```sh
    make -C osdev physical.vmdk
    ```

4.  **Create VirtualBox VM**:
    ```sh
    make -C osdev create-vm
    ```
    This creates a VM definition in VirtualBox that uses the `.vmdk` file and enables [EFI](https://en.wikipedia.org/wiki/UEFI) booting.

5.  **Provision Disk (Optional & DESTRUCTIVE)**: If the disk is empty, you can [partition](https://en.wikipedia.org/wiki/Disk_partitioning) and format it. First, you can check if it's already provisioned correctly:
    ```sh
    sudo make -C osdev check-partitioning
    sudo make -C osdev check-formatting
    ```
    If not, you can use the combined `provision-disk` target. The [partition layout](https://en.wikipedia.org/wiki/Disk_partitioning) is defined in the `Makefile`'s `partition-disk` target. **THIS WILL WIPE THE DISK.**
    ```sh
    sudo make -C osdev provision-disk
    ```
    This runs both `partition-disk` and `format-disk`. You can also run them individually if needed.

6.  **Install an OS**:
    -   To install a minimal [GNU Guix](https://guix.gnu.org/) system, run:
        ```sh
        sudo make -C osdev install-guix
        ```
        This uses the system definition in `config.scm`.
    -   To install only a bootloader for basic testing, run:
        ```sh
        sudo make -C osdev mount-target
        sudo make -C osdev install-bootloader
        sudo make -C osdev unmount-target
        ```

7.  **Run**:
    ```sh
    make -C osdev run
    ```

### Cleanup

If `create-vm` fails or if you want to remove the VM definition from VirtualBox, run:
```sh
make -C osdev destroy-vm
```

To remove the generated `.vmdk` file and force its recreation on the next run, use:
```sh
make -C osdev clean
```

## Files

-   `README.md`: This file.
-   `Makefile`: Automation for setup and management.
-   `config.scm`: A minimal system definition for GNU Guix.
-   `expected-partition-layout.json`: The canonical definition of the disk's partition layout.
-   `check-partition-layout.jq`: A `jq` script to validate the partition layout against the canonical definition.
-   `physical.vmdk`: A placeholder file. The real file is generated by `make physical.vmdk` and points VirtualBox to a raw physical disk.

## Acknowledgements

The approach documented here is based on:

-   [How to Use a Physical Hard Drive with a VirtualBox VM](https://www.serverwatch.com/guides/how-to-use-a-physical-hard-drive-with-a-virtualbox-vm/) by Franklin Okeke, Mar 22, 2023.

## TODO

-   Expand on the base Guix installation.

-   Consider [LVM](https://en.wikipedia.org/wiki/Logical_Volume_Manager_(Linux)) or [btrfs](https://en.wikipedia.org/wiki/Btrfs) to allow for multiple resizable volumes. The current setup uses btrfs for the Guix and shared partitions.
